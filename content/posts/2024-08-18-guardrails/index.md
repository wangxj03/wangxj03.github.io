---
title: "AI Design Pattern: Guardrails"
date: 2024-08-18T17:25:22-07:00
tags: ["AI"]
author: "Xiaojing Wang"
showToc: true
TocOpen: false
draft: false
hidemeta: false
comments: false
disableHLJS: false
disableShare: false
disableHLJS: false
hideSummary: false
searchHidden: true
ShowReadingTime: true
ShowBreadCrumbs: true
ShowPostNavLinks: true
ShowWordCount: false
ShowRssButtonInSectionTermList: false
UseHugoToc: true
---

Guardrails are controls designed to prevent inappropriate content from reaching
or being generated by AI systems. There are two main types: input guardrails and
output guardrails. Input guardrails are used to filter out inappropriate data
before it is processed by the AI system, while output guardrails are used to
prevent the system from generating harmful content.

We adapt an example from OpenAI cookbook [how to use
guardrails](https://cookbook.openai.com/examples/how_to_use_guardrails). We
develop a GenAI chatbot with both input and output guardrails. The input
guardrail ensures only topics related to dogs or cats are discussed, while the
output guardrail prevents the chatbot from providing animal breeding advice.

## Concurrency

When implementing guardrails in a GenAI chatbot, it's crucial to handle multiple
tasks concurrently to ensure efficient processing and responsiveness. In this
design, we employ two concurrent operations:

1. **Input Topic Validation**: This process checks if the user's input topic is related
   to dogs or cats, as defined by the input guardrail. It ensures that the chatbot
   only engages in conversations on approved topics.

1. **Response Generation and Moderation**: Concurrently, the chatbot generates a
   response to the user's query. After generating the response, the output
   guardrail kicks in, moderating the response to ensure it does not include any
   animal breeding advice or other restricted content.

### Implementation

```python
class GuardrailException(Exception):
    pass
```

```python
async def check_topic(client: AsyncOpenAI, model: str, content: str) -> str:
    messages = [
        ChatCompletionSystemMessageParam(role="system", content=TOPIC_GUARDRAIL_PROMPT),
        ChatCompletionUserMessageParam(role="user", content=content),
    ]
    completion = await client.chat.completions.create(
        model=model, messages=messages, temperature=0.0
    )
    return completion.choices[0].message.content or ""


async def topic_guardrail(client: AsyncOpenAI, model: str, content: str) -> None:
    result = await check_topic(client=client, model=model, content=content)
    if result.strip().lower() == "not_allowed":
        raise GuardrailException("Only topics related to dogs or cats are allowed!")
```

```python
async def check_moderation(client: AsyncOpenAI, model: str, content: str) -> str:
    prompt = MODERATION_SYSTEM_PROMPT.format(
        domain=DOMAIN,
        scoring_criteria=ANIMAL_ADVICE_CRITERIA,
        scoring_steps=ANIMAL_ADVICE_STEPS,
        content=content,
    )

    messages = [ChatCompletionUserMessageParam(role="user", content=prompt)]
    completion = await client.chat.completions.create(
        model=model, messages=messages, temperature=0.0
    )
    return completion.choices[0].message.content or ""


async def moderation_guardrail(client: AsyncOpenAI, model: str, content: str) -> None:
    score = await check_moderation(client=client, model=model, content=content)
    if int(score) >= 3:
        raise GuardrailException(
            "Response skipped because animal breeding advice was detected!"
        )
```

## FastAPI Server

TODO

<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AI Design Pattern: Guardrails | Xiaojing's Blog</title>
<meta name=keywords content="AI"><meta name=description content="Guardrails are controls designed to prevent inappropriate content from reaching or being generated by AI systems. There are two main types: input guardrails and output guardrails. Input guardrails are used to filter out inappropriate data before it is processed by the AI system, while output guardrails are used to prevent the system from generating harmful content.
We adapt an example from OpenAI cookbook how to use guardrails. We develop a GenAI chatbot with both input and output guardrails."><meta name=author content="Xiaojing Wang"><link rel=canonical href=https://example.org/posts/2024-08-18-guardrails/><link crossorigin=anonymous href=/assets/css/stylesheet.e7c811b1152f0ea0017b0724f2c040700cf8bf84343fd4fd5eca45af82337db9.css integrity="sha256-58gRsRUvDqABewck8sBAcAz4v4Q0P9T9XspFr4Izfbk=" rel="preload stylesheet" as=style><link rel=icon href=https://example.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://example.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://example.org/favicon-32x32.png><link rel=apple-touch-icon href=https://example.org/apple-touch-icon.png><link rel=mask-icon href=https://example.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://example.org/posts/2024-08-18-guardrails/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="AI Design Pattern: Guardrails"><meta property="og:description" content="Guardrails are controls designed to prevent inappropriate content from reaching or being generated by AI systems. There are two main types: input guardrails and output guardrails. Input guardrails are used to filter out inappropriate data before it is processed by the AI system, while output guardrails are used to prevent the system from generating harmful content.
We adapt an example from OpenAI cookbook how to use guardrails. We develop a GenAI chatbot with both input and output guardrails."><meta property="og:type" content="article"><meta property="og:url" content="https://example.org/posts/2024-08-18-guardrails/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-18T17:25:22-07:00"><meta property="article:modified_time" content="2024-08-18T17:25:22-07:00"><meta property="og:site_name" content="Xiaojing's Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="AI Design Pattern: Guardrails"><meta name=twitter:description content="Guardrails are controls designed to prevent inappropriate content from reaching or being generated by AI systems. There are two main types: input guardrails and output guardrails. Input guardrails are used to filter out inappropriate data before it is processed by the AI system, while output guardrails are used to prevent the system from generating harmful content.
We adapt an example from OpenAI cookbook how to use guardrails. We develop a GenAI chatbot with both input and output guardrails."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://example.org/posts/"},{"@type":"ListItem","position":2,"name":"AI Design Pattern: Guardrails","item":"https://example.org/posts/2024-08-18-guardrails/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AI Design Pattern: Guardrails","name":"AI Design Pattern: Guardrails","description":"Guardrails are controls designed to prevent inappropriate content from reaching or being generated by AI systems. There are two main types: input guardrails and output guardrails. Input guardrails are used to filter out inappropriate data before it is processed by the AI system, while output guardrails are used to prevent the system from generating harmful content.\nWe adapt an example from OpenAI cookbook how to use guardrails. We develop a GenAI chatbot with both input and output guardrails.","keywords":["AI"],"articleBody":"Guardrails are controls designed to prevent inappropriate content from reaching or being generated by AI systems. There are two main types: input guardrails and output guardrails. Input guardrails are used to filter out inappropriate data before it is processed by the AI system, while output guardrails are used to prevent the system from generating harmful content.\nWe adapt an example from OpenAI cookbook how to use guardrails. We develop a GenAI chatbot with both input and output guardrails. The input guardrail ensures only topics related to dogs or cats are discussed, while the output guardrail prevents the chatbot from providing animal breeding advice.\nGuardrail Implementation Input Guardrail We implement the input guardrail with a simple prompt to check if the user query is related to dogs or cats.\nTOPIC_GUARDRAIL_PROMPT = \"\"\" Assess whether the user question is allowed or not. The allowed topics are cats and dogs. \"\"\" The guardrail will raise an exception for any off-topic queries.\nclass TopicGuardrailResult(BaseModel): allowed: bool async def topic_guardrail(client: AsyncOpenAI, model: str, content: str) -\u003e None: messages = [ ChatCompletionSystemMessageParam(role=\"system\", content=TOPIC_GUARDRAIL_PROMPT), ChatCompletionUserMessageParam(role=\"user\", content=content), ] completion = await client.beta.chat.completions.parse( model=model, messages=messages, temperature=0.0, response_format=TopicGuardrailResult, ) parsed = completion.choices[0].message.parsed if parsed is None or not parsed.allowed: raise GuardrailException(\"Only topics related to dogs or cats are allowed!\") In this implementation, we use OpenAI’s latest structured outputs feature to parse the response.\nOutput Guardrail We implement the output guardrail with a prompt template that includes the domain, scoring criteria, and scoring steps for the animal breeding advice moderation.\nDOMAIN = \"animal breed recommendation\" ANIMAL_ADVICE_CRITERIA = \"\"\" Assess the presence of explicit recommendation of cat or dog breeds in the content. The content should contain only general advice about cats and dogs, not specific breeds to purchase. \"\"\" ANIMAL_ADVICE_STEPS = \"\"\" 1. Read the content and the criteria carefully. 2. Assess how much explicit recommendation of cat or dog breeds is contained in the content. 3. Assign an animal advice score from 1 to 5, with 1 being no explicit cat or dog breed advice, and 5 being multiple named cat or dog breeds. \"\"\" MODERATION_GUARDRAIL_PROMPT = \"\"\" You are a moderation assistant. Your role is to detect content about {domain} in the text provided, and mark the severity of that content. ## {domain} ### Criteria {scoring_criteria} ### Instructions {scoring_steps} ### Content {content} ### Evaluation (score only!) \"\"\" The guardrail will raise an exception if the score exceeds a certain threshold.\nclass ModerationGuardrailResult(BaseModel): score: int async def moderation_guardrail(client: AsyncOpenAI, model: str, content: str) -\u003e None: prompt = MODERATION_GUARDRAIL_PROMPT.format( domain=DOMAIN, scoring_criteria=ANIMAL_ADVICE_CRITERIA, scoring_steps=ANIMAL_ADVICE_STEPS, content=content, ) messages = [ChatCompletionUserMessageParam(role=\"user\", content=prompt)] completion = await client.beta.chat.completions.parse( model=model, messages=messages, temperature=0.0, response_format=ModerationGuardrailResult, ) parsed = completion.choices[0].message.parsed if parsed is None or parsed.score \u003e= 3: raise GuardrailException( \"Response skipped because animal breeding advice was detected!\" ) Concurrency When implementing guardrails in a GenAI chatbot, it’s essential to manage multiple tasks concurrently to maintain both efficiency and responsiveness. The orchestration of these tasks can be visualized as a Directed Acyclic Graph (DAG), where each task is a node, and dependencies determine the execution flow.\nIn this design, we organize the guardrails into two concurrent tasks:\nRun topic guardrail\nRun chat completion and moderation guardrail which includes two subtasks running sequentially.\nIf the topic guardrail raises an exception—indicating that the user’s input is off-topic—the second task, which is handling the chat completion and moderation, will be canceled if it is still running. This early cancellation prevents unnecessary processing, saving computational resources. Similarly, if the moderation guardrail detects inappropriate content in the generated response, the chat completion will be effectively skipped, and an error message will be returned instead.\nWe don’t need to use a fancy orchestration framework for this simple example. Basic Python constructs like asyncio.create_task is sufficient.\nasync def chat_with_guardrails( client: AsyncOpenAI, model: str, messages: list[ChatCompletionMessageParam] ) -\u003e ChatCompletion: last_message = messages[-1] content = str(last_message[\"content\"]) async def run_topic_guardrail(): await topic_guardrail(client=client, model=model, content=content) async def run_completion_and_moderation_guardrail(): completion = await client.chat.completions.create( model=model, messages=messages ) content = completion.choices[0].message.content or \"\" await moderation_guardrail(client=client, model=model, content=content) return completion try: topic_task = asyncio.create_task(run_topic_guardrail()) completion_task = asyncio.create_task(run_completion_and_moderation_guardrail()) # Wait for topic check to complete await topic_task # If topic check passes, wait for completion and moderation check completion = await completion_task return completion except GuardrailException as e: completion_task.cancel() error_message = str(e) except Exception as e: raise HTTPException(status_code=500, detail=f\"Unexpected error: {str(e)}\") # If a GuardrailException was caught, return an error completion return ChatCompletion( id=f\"chatcomp-{uuid4()}\", choices=[ ChatCompletionChoice( index=0, message=ChatCompletionMessage(role=\"assistant\", content=error_message), finish_reason=\"stop\", ) ], created=int(time.time()), model=model, object=\"chat.completion\", ) FastAPI Server We create a simple FastAPI server to interact with the GenAI chatbot.\nclass ChatCompletionRequest(BaseModel): model: str messages: list[ChatCompletionMessageParam] def create_fastapi_app(client: AsyncOpenAI) -\u003e FastAPI: fastapi_app = FastAPI() @fastapi_app.post(\"/v1/chat/completions\", response_model=ChatCompletion) async def chat(request: ChatCompletionRequest) -\u003e ChatCompletion: return await chat_with_guardrails( client=client, model=request.model, messages=request.messages ) return fastapi_app The service features a single endpoint /v1/chat/completions that is compatible to OpenAI’s chat completion API.\nObservability Sample Request: Good curl -X POST \"http://0.0.0.0:8000/v1/chat/completions\" \\ -H \"Content-Type: application/json\" \\ -d '{ \"model\": \"gpt-4o-2024-08-06\", \"messages\": [ { \"role\": \"user\", \"content\": \"How can I introduce a new dog to my cat?\" } ] }' | jq Click to see response { \"id\": \"chatcmpl-9yAuyWj80qJ5zIhuMxntXsIEQToL9\", \"choices\": [ { \"finish_reason\": \"stop\", \"index\": 0, \"logprobs\": null, \"message\": { \"content\": \"Introducing a new dog to your cat requires patience and careful planning to ensure a smooth transition for both pets. Here are some steps you can follow:\\n\\n1. **Prepare a Safe Environment**: \\n - Set up separate spaces for each animal. Your cat should have a dog-free zone where it feels safe, such as a high perch or a room that the dog can't access.\\n - Ensure the dog is familiar with basic commands like \\\"sit,\\\" \\\"stay,\\\" or \\\"leave it,\\\" especially if it is not a puppy.\\n\\n2. **Scent Introduction**:\\n - Before the face-to-face meeting, let each animal get used to the other's scent. Swap bedding or use a cloth to gently rub the dog and then the cat, allowing them to sniff each other’s scent.\\n\\n3. **Controlled Initial Meeting**:\\n - Keep the dog on a leash during the first interaction and allow the cat to approach at its own pace. Reward the dog for calm behavior.\\n - Observe their reactions. If either animal seems stressed or aggressive, separate them and try again later.\\n\\n4. **Short, Positive Interactions**:\\n - Start with short meeting sessions and gradually increase their time together. Always supervise these interactions.\\n - Reward both pets with treats and praise to associate each other's presence with positive experiences.\\n\\n5. **Manage Stress**:\\n - Maintain a calm environment. Keep loud noises and disruptions to a minimum to help reduce stress.\\n - Provide each pet with their own resources like food bowls, toys, and litter boxes to prevent competition.\\n\\n6. **Monitor Body Language**:\\n - Pay attention to both pets’ body language. A wagging tail in a dog can signify excitement or tension, while a cat’s raised fur or growling can indicate stress.\\n - If the situation becomes tense, separate the animals and give them a break.\\n\\n7. **Gradual Increase in Exposure**:\\n - As they become more comfortable with each other, allow them more freedom to interact without barriers. Continue to supervise these interactions until you are confident they are comfortable together.\\n\\n8. **Consult Professionals if Needed**:\\n - If you're having trouble with the introduction or if either pet shows signs of stress or aggression, consider seeking advice from a professional animal behaviorist.\\n\\nRemember, every animal is unique, and some introductions may take longer than others. Be patient and move at a pace that is comfortable for both the dog and the cat.\", \"refusal\": null, \"role\": \"assistant\", \"function_call\": null, \"tool_calls\": null } } ], \"created\": 1724128676, \"model\": \"gpt-4o-2024-08-06\", \"object\": \"chat.completion\", \"service_tier\": null, \"system_fingerprint\": \"fp_baa7103b2c\", \"usage\": { \"completion_tokens\": 492, \"prompt_tokens\": 18, \"total_tokens\": 510 } } Sample Request: Bad Input curl -X POST \"http://0.0.0.0:8000/v1/chat/completions\" \\ -H \"Content-Type: application/json\" \\ -d '{ \"model\": \"gpt-4o-2024-08-06\", \"messages\": [ { \"role\": \"user\", \"content\": \"I love pandas!\" } ] }' | jq Click to see response { \"id\": \"chatcomp-f1c51605-f8d5-4fc5-9a47-f87ba7cc84d9\", \"choices\": [ { \"finish_reason\": \"stop\", \"index\": 0, \"logprobs\": null, \"message\": { \"content\": \"Only topics related to dogs or cats are allowed!\", \"refusal\": null, \"role\": \"assistant\", \"function_call\": null, \"tool_calls\": null } } ], \"created\": 1724129166, \"model\": \"gpt-4o-2024-08-06\", \"object\": \"chat.completion\", \"service_tier\": null, \"system_fingerprint\": null, \"usage\": null } Sample Request: Bad Output curl -X POST \"http://0.0.0.0:8000/v1/chat/completions\" \\ -H \"Content-Type: application/json\" \\ -d '{ \"model\": \"gpt-4o-2024-08-06\", \"messages\": [ { \"role\": \"user\", \"content\": \"What are the best breeds of dog for people that like cats?\" } ] }' | jq Click to see response { \"id\": \"chatcomp-a9bcfe59-d970-4cb0-bb5e-fbbcc60c4f9b\", \"choices\": [ { \"finish_reason\": \"stop\", \"index\": 0, \"logprobs\": null, \"message\": { \"content\": \"Response skipped because animal breeding advice was detected!\", \"refusal\": null, \"role\": \"assistant\", \"function_call\": null, \"tool_calls\": null } } ], \"created\": 1724129317, \"model\": \"gpt-4o-2024-08-06\", \"object\": \"chat.completion\", \"service_tier\": null, \"system_fingerprint\": null, \"usage\": null } ","wordCount":"1443","inLanguage":"en","datePublished":"2024-08-18T17:25:22-07:00","dateModified":"2024-08-18T17:25:22-07:00","author":{"@type":"Person","name":"Xiaojing Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://example.org/posts/2024-08-18-guardrails/"},"publisher":{"@type":"Organization","name":"Xiaojing's Blog","logo":{"@type":"ImageObject","url":"https://example.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://example.org/ accesskey=h title="Home (Alt + H)"><img src=https://example.org/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://example.org/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://example.org/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://example.org/>Home</a>&nbsp;»&nbsp;<a href=https://example.org/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">AI Design Pattern: Guardrails</h1><div class=post-meta><span title='2024-08-18 17:25:22 -0700 PDT'>August 18, 2024</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Xiaojing Wang</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#guardrail-implementation>Guardrail Implementation</a><ul><li><a href=#input-guardrail>Input Guardrail</a></li><li><a href=#output-guardrail>Output Guardrail</a></li><li><a href=#concurrency>Concurrency</a></li></ul></li><li><a href=#fastapi-server>FastAPI Server</a></li><li><a href=#observability>Observability</a><ul><li><a href=#sample-request-good>Sample Request: Good</a></li><li><a href=#sample-request-bad-input>Sample Request: Bad Input</a></li><li><a href=#sample-request-bad-output>Sample Request: Bad Output</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>Guardrails are controls designed to prevent inappropriate content from reaching
or being generated by AI systems. There are two main types: input guardrails and
output guardrails. Input guardrails are used to filter out inappropriate data
before it is processed by the AI system, while output guardrails are used to
prevent the system from generating harmful content.</p><p>We adapt an example from OpenAI cookbook <a href=https://cookbook.openai.com/examples/how_to_use_guardrails>how to use
guardrails</a>. We
develop a GenAI chatbot with both input and output guardrails. The input
guardrail ensures only topics related to dogs or cats are discussed, while the
output guardrail prevents the chatbot from providing animal breeding advice.</p><h2 id=guardrail-implementation>Guardrail Implementation<a hidden class=anchor aria-hidden=true href=#guardrail-implementation>#</a></h2><h3 id=input-guardrail>Input Guardrail<a hidden class=anchor aria-hidden=true href=#input-guardrail>#</a></h3><p>We implement the input guardrail with a simple prompt to check if the user query
is related to dogs or cats.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>TOPIC_GUARDRAIL_PROMPT <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Assess whether the user question is allowed or not. The allowed topics are cats and dogs.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>The guardrail will raise an exception for any off-topic queries.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TopicGuardrailResult</span>(BaseModel):
</span></span><span style=display:flex><span>    allowed: bool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>topic_guardrail</span>(client: AsyncOpenAI, model: str, content: str) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    messages <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        ChatCompletionSystemMessageParam(role<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;system&#34;</span>, content<span style=color:#f92672>=</span>TOPIC_GUARDRAIL_PROMPT),
</span></span><span style=display:flex><span>        ChatCompletionUserMessageParam(role<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;user&#34;</span>, content<span style=color:#f92672>=</span>content),
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>    completion <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> client<span style=color:#f92672>.</span>beta<span style=color:#f92672>.</span>chat<span style=color:#f92672>.</span>completions<span style=color:#f92672>.</span>parse(
</span></span><span style=display:flex><span>        model<span style=color:#f92672>=</span>model,
</span></span><span style=display:flex><span>        messages<span style=color:#f92672>=</span>messages,
</span></span><span style=display:flex><span>        temperature<span style=color:#f92672>=</span><span style=color:#ae81ff>0.0</span>,
</span></span><span style=display:flex><span>        response_format<span style=color:#f92672>=</span>TopicGuardrailResult,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    parsed <span style=color:#f92672>=</span> completion<span style=color:#f92672>.</span>choices[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>message<span style=color:#f92672>.</span>parsed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> parsed <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> parsed<span style=color:#f92672>.</span>allowed:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> GuardrailException(<span style=color:#e6db74>&#34;Only topics related to dogs or cats are allowed!&#34;</span>)
</span></span></code></pre></div><p>In this implementation, we use OpenAI&rsquo;s latest <a href=https://platform.openai.com/docs/guides/structured-outputs>structured
outputs</a> feature to
parse the response.</p><h3 id=output-guardrail>Output Guardrail<a hidden class=anchor aria-hidden=true href=#output-guardrail>#</a></h3><p>We implement the output guardrail with a prompt template that includes the
domain, scoring criteria, and scoring steps for the animal breeding advice
moderation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>DOMAIN <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;animal breed recommendation&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ANIMAL_ADVICE_CRITERIA <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Assess the presence of explicit recommendation of cat or dog breeds in the content.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>The content should contain only general advice about cats and dogs, not specific breeds to purchase.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ANIMAL_ADVICE_STEPS <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>1. Read the content and the criteria carefully.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>2. Assess how much explicit recommendation of cat or dog breeds is contained in the content.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>3. Assign an animal advice score from 1 to 5, with 1 being no explicit cat or dog breed advice, and 5 being multiple named cat or dog breeds.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MODERATION_GUARDRAIL_PROMPT <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>You are a moderation assistant. Your role is to detect content about </span><span style=color:#e6db74>{domain}</span><span style=color:#e6db74> in the text provided, and mark the severity of that content.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>## </span><span style=color:#e6db74>{domain}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>### Criteria
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{scoring_criteria}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>### Instructions
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{scoring_steps}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>### Content
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{content}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>### Evaluation (score only!)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>The guardrail will raise an exception if the score exceeds a certain threshold.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ModerationGuardrailResult</span>(BaseModel):
</span></span><span style=display:flex><span>    score: int
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>moderation_guardrail</span>(client: AsyncOpenAI, model: str, content: str) <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    prompt <span style=color:#f92672>=</span> MODERATION_GUARDRAIL_PROMPT<span style=color:#f92672>.</span>format(
</span></span><span style=display:flex><span>        domain<span style=color:#f92672>=</span>DOMAIN,
</span></span><span style=display:flex><span>        scoring_criteria<span style=color:#f92672>=</span>ANIMAL_ADVICE_CRITERIA,
</span></span><span style=display:flex><span>        scoring_steps<span style=color:#f92672>=</span>ANIMAL_ADVICE_STEPS,
</span></span><span style=display:flex><span>        content<span style=color:#f92672>=</span>content,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    messages <span style=color:#f92672>=</span> [ChatCompletionUserMessageParam(role<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;user&#34;</span>, content<span style=color:#f92672>=</span>prompt)]
</span></span><span style=display:flex><span>    completion <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> client<span style=color:#f92672>.</span>beta<span style=color:#f92672>.</span>chat<span style=color:#f92672>.</span>completions<span style=color:#f92672>.</span>parse(
</span></span><span style=display:flex><span>        model<span style=color:#f92672>=</span>model,
</span></span><span style=display:flex><span>        messages<span style=color:#f92672>=</span>messages,
</span></span><span style=display:flex><span>        temperature<span style=color:#f92672>=</span><span style=color:#ae81ff>0.0</span>,
</span></span><span style=display:flex><span>        response_format<span style=color:#f92672>=</span>ModerationGuardrailResult,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    parsed <span style=color:#f92672>=</span> completion<span style=color:#f92672>.</span>choices[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>message<span style=color:#f92672>.</span>parsed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> parsed <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>or</span> parsed<span style=color:#f92672>.</span>score <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> GuardrailException(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Response skipped because animal breeding advice was detected!&#34;</span>
</span></span><span style=display:flex><span>        )
</span></span></code></pre></div><h3 id=concurrency>Concurrency<a hidden class=anchor aria-hidden=true href=#concurrency>#</a></h3><p>When implementing guardrails in a GenAI chatbot, it&rsquo;s essential to manage
multiple tasks concurrently to maintain both efficiency and responsiveness. The
orchestration of these tasks can be visualized as a Directed Acyclic Graph
(DAG), where each task is a node, and dependencies determine the execution flow.</p><p>In this design, we organize the guardrails into two concurrent tasks:</p><ol><li><p><strong>Run topic guardrail</strong></p></li><li><p><strong>Run chat completion and moderation guardrail</strong> which includes two subtasks
running sequentially.</p></li></ol><p>If the topic guardrail raises an exception—indicating that the user&rsquo;s input is
off-topic—the second task, which is handling the chat completion and moderation,
will be canceled if it is still running. This early cancellation prevents
unnecessary processing, saving computational resources. Similarly, if the
moderation guardrail detects inappropriate content in the generated response,
the chat completion will be effectively skipped, and an error message will be
returned instead.</p><p>We don&rsquo;t need to use a fancy orchestration framework for this simple example.
Basic Python constructs like <code>asyncio.create_task</code> is sufficient.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>chat_with_guardrails</span>(
</span></span><span style=display:flex><span>    client: AsyncOpenAI, model: str, messages: list[ChatCompletionMessageParam]
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> ChatCompletion:
</span></span><span style=display:flex><span>    last_message <span style=color:#f92672>=</span> messages[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    content <span style=color:#f92672>=</span> str(last_message[<span style=color:#e6db74>&#34;content&#34;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_topic_guardrail</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> topic_guardrail(client<span style=color:#f92672>=</span>client, model<span style=color:#f92672>=</span>model, content<span style=color:#f92672>=</span>content)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run_completion_and_moderation_guardrail</span>():
</span></span><span style=display:flex><span>        completion <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> client<span style=color:#f92672>.</span>chat<span style=color:#f92672>.</span>completions<span style=color:#f92672>.</span>create(
</span></span><span style=display:flex><span>            model<span style=color:#f92672>=</span>model, messages<span style=color:#f92672>=</span>messages
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        content <span style=color:#f92672>=</span> completion<span style=color:#f92672>.</span>choices[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>message<span style=color:#f92672>.</span>content <span style=color:#f92672>or</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> moderation_guardrail(client<span style=color:#f92672>=</span>client, model<span style=color:#f92672>=</span>model, content<span style=color:#f92672>=</span>content)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> completion
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        topic_task <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>create_task(run_topic_guardrail())
</span></span><span style=display:flex><span>        completion_task <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>create_task(run_completion_and_moderation_guardrail())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Wait for topic check to complete</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> topic_task
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># If topic check passes, wait for completion and moderation check</span>
</span></span><span style=display:flex><span>        completion <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> completion_task
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> completion
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> GuardrailException <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        completion_task<span style=color:#f92672>.</span>cancel()
</span></span><span style=display:flex><span>        error_message <span style=color:#f92672>=</span> str(e)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> HTTPException(status_code<span style=color:#f92672>=</span><span style=color:#ae81ff>500</span>, detail<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Unexpected error: </span><span style=color:#e6db74>{</span>str(e)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># If a GuardrailException was caught, return an error completion</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ChatCompletion(
</span></span><span style=display:flex><span>        id<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;chatcomp-</span><span style=color:#e6db74>{</span>uuid4()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>        choices<span style=color:#f92672>=</span>[
</span></span><span style=display:flex><span>            ChatCompletionChoice(
</span></span><span style=display:flex><span>                index<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>                message<span style=color:#f92672>=</span>ChatCompletionMessage(role<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;assistant&#34;</span>, content<span style=color:#f92672>=</span>error_message),
</span></span><span style=display:flex><span>                finish_reason<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;stop&#34;</span>,
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        created<span style=color:#f92672>=</span>int(time<span style=color:#f92672>.</span>time()),
</span></span><span style=display:flex><span>        model<span style=color:#f92672>=</span>model,
</span></span><span style=display:flex><span>        object<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;chat.completion&#34;</span>,
</span></span><span style=display:flex><span>    )
</span></span></code></pre></div><h2 id=fastapi-server>FastAPI Server<a hidden class=anchor aria-hidden=true href=#fastapi-server>#</a></h2><p>We create a simple FastAPI server to interact with the GenAI chatbot.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ChatCompletionRequest</span>(BaseModel):
</span></span><span style=display:flex><span>    model: str
</span></span><span style=display:flex><span>    messages: list[ChatCompletionMessageParam]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_fastapi_app</span>(client: AsyncOpenAI) <span style=color:#f92672>-&gt;</span> FastAPI:
</span></span><span style=display:flex><span>    fastapi_app <span style=color:#f92672>=</span> FastAPI()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@fastapi_app.post</span>(<span style=color:#e6db74>&#34;/v1/chat/completions&#34;</span>, response_model<span style=color:#f92672>=</span>ChatCompletion)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>chat</span>(request: ChatCompletionRequest) <span style=color:#f92672>-&gt;</span> ChatCompletion:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> chat_with_guardrails(
</span></span><span style=display:flex><span>            client<span style=color:#f92672>=</span>client, model<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>model, messages<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>messages
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> fastapi_app
</span></span></code></pre></div><p>The service features a single endpoint <code>/v1/chat/completions</code> that is compatible
to OpenAI&rsquo;s chat completion API.</p><h2 id=observability>Observability<a hidden class=anchor aria-hidden=true href=#observability>#</a></h2><h3 id=sample-request-good>Sample Request: Good<a hidden class=anchor aria-hidden=true href=#sample-request-good>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;http://0.0.0.0:8000/v1/chat/completions&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;model&#34;: &#34;gpt-4o-2024-08-06&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;messages&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;role&#34;: &#34;user&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;content&#34;: &#34;How can I introduce a new dog to my cat?&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span> | jq
</span></span></code></pre></div><details><summary>Click to see response</summary><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;chatcmpl-9yAuyWj80qJ5zIhuMxntXsIEQToL9&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;choices&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;finish_reason&#34;</span>: <span style=color:#e6db74>&#34;stop&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;index&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;logprobs&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;message&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;content&#34;</span>: <span style=color:#e6db74>&#34;Introducing a new dog to your cat requires patience and careful planning to ensure a smooth transition for both pets. Here are some steps you can follow:\n\n1. **Prepare a Safe Environment**: \n   - Set up separate spaces for each animal. Your cat should have a dog-free zone where it feels safe, such as a high perch or a room that the dog can&#39;t access.\n   - Ensure the dog is familiar with basic commands like \&#34;sit,\&#34; \&#34;stay,\&#34; or \&#34;leave it,\&#34; especially if it is not a puppy.\n\n2. **Scent Introduction**:\n   - Before the face-to-face meeting, let each animal get used to the other&#39;s scent. Swap bedding or use a cloth to gently rub the dog and then the cat, allowing them to sniff each other’s scent.\n\n3. **Controlled Initial Meeting**:\n   - Keep the dog on a leash during the first interaction and allow the cat to approach at its own pace. Reward the dog for calm behavior.\n   - Observe their reactions. If either animal seems stressed or aggressive, separate them and try again later.\n\n4. **Short, Positive Interactions**:\n   - Start with short meeting sessions and gradually increase their time together. Always supervise these interactions.\n   - Reward both pets with treats and praise to associate each other&#39;s presence with positive experiences.\n\n5. **Manage Stress**:\n   - Maintain a calm environment. Keep loud noises and disruptions to a minimum to help reduce stress.\n   - Provide each pet with their own resources like food bowls, toys, and litter boxes to prevent competition.\n\n6. **Monitor Body Language**:\n   - Pay attention to both pets’ body language. A wagging tail in a dog can signify excitement or tension, while a cat’s raised fur or growling can indicate stress.\n   - If the situation becomes tense, separate the animals and give them a break.\n\n7. **Gradual Increase in Exposure**:\n   - As they become more comfortable with each other, allow them more freedom to interact without barriers. Continue to supervise these interactions until you are confident they are comfortable together.\n\n8. **Consult Professionals if Needed**:\n   - If you&#39;re having trouble with the introduction or if either pet shows signs of stress or aggression, consider seeking advice from a professional animal behaviorist.\n\nRemember, every animal is unique, and some introductions may take longer than others. Be patient and move at a pace that is comfortable for both the dog and the cat.&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;refusal&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;assistant&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;function_call&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;tool_calls&#34;</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;created&#34;</span>: <span style=color:#ae81ff>1724128676</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;model&#34;</span>: <span style=color:#e6db74>&#34;gpt-4o-2024-08-06&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;object&#34;</span>: <span style=color:#e6db74>&#34;chat.completion&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;service_tier&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;system_fingerprint&#34;</span>: <span style=color:#e6db74>&#34;fp_baa7103b2c&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;usage&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;completion_tokens&#34;</span>: <span style=color:#ae81ff>492</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;prompt_tokens&#34;</span>: <span style=color:#ae81ff>18</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;total_tokens&#34;</span>: <span style=color:#ae81ff>510</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></details><p><img loading=lazy src=trace_good.png alt></p><h3 id=sample-request-bad-input>Sample Request: Bad Input<a hidden class=anchor aria-hidden=true href=#sample-request-bad-input>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;http://0.0.0.0:8000/v1/chat/completions&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;model&#34;: &#34;gpt-4o-2024-08-06&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;messages&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;role&#34;: &#34;user&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;content&#34;: &#34;I love pandas!&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span> | jq
</span></span></code></pre></div><details><summary>Click to see response</summary><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;chatcomp-f1c51605-f8d5-4fc5-9a47-f87ba7cc84d9&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;choices&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;finish_reason&#34;</span>: <span style=color:#e6db74>&#34;stop&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;index&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;logprobs&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;message&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;content&#34;</span>: <span style=color:#e6db74>&#34;Only topics related to dogs or cats are allowed!&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;refusal&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;assistant&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;function_call&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;tool_calls&#34;</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;created&#34;</span>: <span style=color:#ae81ff>1724129166</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;model&#34;</span>: <span style=color:#e6db74>&#34;gpt-4o-2024-08-06&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;object&#34;</span>: <span style=color:#e6db74>&#34;chat.completion&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;service_tier&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;system_fingerprint&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;usage&#34;</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></details><p><img loading=lazy src=trace_bad_topic.png alt></p><h3 id=sample-request-bad-output>Sample Request: Bad Output<a hidden class=anchor aria-hidden=true href=#sample-request-bad-output>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;http://0.0.0.0:8000/v1/chat/completions&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     -d <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;model&#34;: &#34;gpt-4o-2024-08-06&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;messages&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;role&#34;: &#34;user&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;content&#34;: &#34;What are the best breeds of dog for people that like cats?&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span> | jq
</span></span></code></pre></div><details><summary>Click to see response</summary><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;chatcomp-a9bcfe59-d970-4cb0-bb5e-fbbcc60c4f9b&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;choices&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;finish_reason&#34;</span>: <span style=color:#e6db74>&#34;stop&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;index&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;logprobs&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;message&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;content&#34;</span>: <span style=color:#e6db74>&#34;Response skipped because animal breeding advice was detected!&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;refusal&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;assistant&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;function_call&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;tool_calls&#34;</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;created&#34;</span>: <span style=color:#ae81ff>1724129317</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;model&#34;</span>: <span style=color:#e6db74>&#34;gpt-4o-2024-08-06&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;object&#34;</span>: <span style=color:#e6db74>&#34;chat.completion&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;service_tier&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;system_fingerprint&#34;</span>: <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;usage&#34;</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></details><p><img loading=lazy src=trace_bad_moderation.png alt></p><p><img loading=lazy src=moderation_guardrail.png alt></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://example.org/tags/ai/>AI</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share AI Design Pattern: Guardrails on x" href="https://x.com/intent/tweet/?text=AI%20Design%20Pattern%3a%20Guardrails&amp;url=https%3a%2f%2fexample.org%2fposts%2f2024-08-18-guardrails%2f&amp;hashtags=AI"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AI Design Pattern: Guardrails on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fexample.org%2fposts%2f2024-08-18-guardrails%2f&amp;title=AI%20Design%20Pattern%3a%20Guardrails&amp;summary=AI%20Design%20Pattern%3a%20Guardrails&amp;source=https%3a%2f%2fexample.org%2fposts%2f2024-08-18-guardrails%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AI Design Pattern: Guardrails on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fexample.org%2fposts%2f2024-08-18-guardrails%2f&title=AI%20Design%20Pattern%3a%20Guardrails"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AI Design Pattern: Guardrails on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fexample.org%2fposts%2f2024-08-18-guardrails%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AI Design Pattern: Guardrails on whatsapp" href="https://api.whatsapp.com/send?text=AI%20Design%20Pattern%3a%20Guardrails%20-%20https%3a%2f%2fexample.org%2fposts%2f2024-08-18-guardrails%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AI Design Pattern: Guardrails on telegram" href="https://telegram.me/share/url?text=AI%20Design%20Pattern%3a%20Guardrails&amp;url=https%3a%2f%2fexample.org%2fposts%2f2024-08-18-guardrails%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share AI Design Pattern: Guardrails on ycombinator" href="https://news.ycombinator.com/submitlink?t=AI%20Design%20Pattern%3a%20Guardrails&u=https%3a%2f%2fexample.org%2fposts%2f2024-08-18-guardrails%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://example.org/>Xiaojing's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>